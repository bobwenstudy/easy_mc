#include <stdlib.h>
#include <math.h>

#include "easy_mc.h"

#include <stdio.h>
#include <string.h>

float input_data[251] = {
        0.00,  0.86,  1.59,  2.10,  2.35,  2.35,  2.18,  1.94,  1.76,  1.73,  1.90,  2.26,  2.75,  3.24,  3.63,  3.80,  3.70,  3.30,  2.68,  1.93,  1.18,
        0.54,  0.11,  -0.10, -0.11, 0.00,  0.11,  0.10,  -0.11, -0.54, -1.18, -1.93, -2.68, -3.30, -3.70, -3.80, -3.63, -3.24, -2.75, -2.26, -1.90, -1.73,
        -1.76, -1.94, -2.18, -2.35, -2.35, -2.10, -1.59, -0.86, 0.00,  0.86,  1.59,  2.10,  2.35,  2.35,  2.18,  1.94,  1.76,  1.73,  1.90,  2.26,  2.75,
        3.24,  3.63,  3.80,  3.70,  3.30,  2.68,  1.93,  1.18,  0.54,  0.11,  -0.10, -0.11, 0.00,  0.11,  0.10,  -0.11, -0.54, -1.18, -1.93, -2.68, -3.30,
        -3.70, -3.80, -3.63, -3.24, -2.75, -2.26, -1.90, -1.73, -1.76, -1.94, -2.18, -2.35, -2.35, -2.10, -1.59, -0.86, 0.00,  0.86,  1.59,  2.10,  2.35,
        2.35,  2.18,  1.94,  1.76,  1.73,  1.90,  2.26,  2.75,  3.24,  3.63,  3.80,  3.70,  3.30,  2.68,  1.93,  1.18,  0.54,  0.11,  -0.10, -0.11, 0.00,
        0.11,  0.10,  -0.11, -0.54, -1.18, -1.93, -2.68, -3.30, -3.70, -3.80, -3.63, -3.24, -2.75, -2.26, -1.90, -1.73, -1.76, -1.94, -2.18, -2.35, -2.35,
        -2.10, -1.59, -0.86, 0.00,  0.86,  1.59,  2.10,  2.35,  2.35,  2.18,  1.94,  1.76,  1.73,  1.90,  2.26,  2.75,  3.24,  3.63,  3.80,  3.70,  3.30,
        2.68,  1.93,  1.18,  0.54,  0.11,  -0.10, -0.11, 0.00,  0.11,  0.10,  -0.11, -0.54, -1.18, -1.93, -2.68, -3.30, -3.70, -3.80, -3.63, -3.24, -2.75,
        -2.26, -1.90, -1.73, -1.76, -1.94, -2.18, -2.35, -2.35, -2.10, -1.59, -0.86, 0.00,  0.86,  1.59,  2.10,  2.35,  2.35,  2.18,  1.94,  1.76,  1.73,
        1.90,  2.26,  2.75,  3.24,  3.63,  3.80,  3.70,  3.30,  2.68,  1.93,  1.18,  0.54,  0.11,  -0.10, -0.11, 0.00,  0.11,  0.10,  -0.11, -0.54, -1.18,
        -1.93, -2.68, -3.30, -3.70, -3.80, -3.63, -3.24, -2.75, -2.26, -1.90, -1.73, -1.76, -1.94, -2.18, -2.35, -2.35, -2.10, -1.59, -0.86, 0.00};

float get_data(void)
{
    static int i = 0;
    if (i >= sizeof(input_data) / sizeof(input_data[0]))
    {
        i = 0;
    }
    return (input_data[i++]);
}

struct filter_test_vofa_data
{
    float input;
    float output;

    unsigned char tail[4];
};

static easy_mc_filter_low_pass_t speed_filter;

void filter_test(void)
{
    struct filter_test_vofa_data vofa_data = {.tail = {0x00, 0x00, 0x80, 0x7f}};
    float input = get_data();
    float output = easy_mc_filter_low_pass_process(&speed_filter, input);

    // Set data to vofa_data
    vofa_data.input = input;
    vofa_data.output = output;

    // EASY_MC_LOG_INF("input:%f, output:%f\r\n", input, output);

    easy_mc_hw_vofa_debug_out((uint8_t *)&vofa_data, sizeof(vofa_data));

    // Avoid uart send too fast
    HAL_Delay(1);
}

void app_main(void)
{
    EASY_MC_LOG_INF("filter_low_pass_test\r\n");
    easy_mc_filter_low_pass_init(&speed_filter, 2.0f, 0.02f); // 2Hz截止频率，0.02s采样周期
}

void app_main_loop(void)
{
    filter_test();
}
